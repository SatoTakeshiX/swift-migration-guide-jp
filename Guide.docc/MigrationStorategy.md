原文: https://github.com/apple/swift-migration-guide/blob/main/Guide.docc/MigrationStrategy.md

更新日: 2024/6/20

ここまで反映: https://github.com/apple/swift-migration-guide/commit/40b11e0f54b6d35345d005511e013c230a520d26


# 移行戦略

Swift 6言語モードへプロジェクトを移行し始めましょう。

モジュールでStrict Concurrency CheckをCompleteにすると、コンパイラによって報告される多くのデータ競合の安全性の問題が発生する可能性があります。数百、場合によっては数千の警告は珍しくありません。そのような膨大の問題に直面したとき、特にSwiftのデータ隔離モデルについて学び始めたばかりであった場合、これは難し過ぎると感じるかもしれません。

**慌てないで**

移行を進めていくと、実際、たいていの場合はほんの少し変更を加えるだけで移行を進めていけることに気づくでしょう。そして、その過程を通して、Swiftの並行処理システムがどのように動作するかについてのメンタルモデルが、あなたの頭の中に急速に作られていくでしょう。

> 重要：このガイダンスが推奨された方法だと思わないでください。自信を持って他のアプローチを取ってください。

## 戦略

このドキュメントでは、よいスタート地点となる得る一般的な戦略の概要を説明します。すべてのプロジェクトに有効な単一のアプローチはありません。

このアプローチには、次の3つの主要なステップがあります:
- モジュールを選択する
- Swift 5でより厳密なチェックを有効にする
- 警告に対処する

このプロセスは繰り返し行なうものです。1つのモジュールのたった1つの変更であっても、プロジェクト全体の状態に大きな影響を与える可能性があります。

## 外側から始める

プロジェクトの最も外側にある根本のモジュールから始める方が簡単な可能性があります。これは、このモジュールは定義上、他のモジュールに依存していないからです。ここでの変更は、局所的にしか影響を及ぼさないので、作業量を抑制できます。

しかし、変更は、そのモジュールだけで終える**必要はありません**。あなたがコントロールできる、安全でないグローバルな状態や自動で`Sendable`に準拠している型が存在する依存関係は、プロジェクト全体の中の多くの警告の根本原因になる場合があります。多くの場合、これらは最初に焦点を当てると最もよいものです。

## Swift5言語モードを使う

何もチェックせず、Swift 5からSwift 6言語モードにいきなりプロジェクトを移行させるのは、とても難しいと感じるかもしれません。その代わりに、Swift 5言語モードのままで、Swift 6のチェックメカニズムの多くを段階的に有効にできます。これは、問題のある部分を警告としてのみ表示し、ビルドとテストをこれまで通り動かすことができます。

まず、Swift Concurrencyのupcoming featureを1つだけ有効にします。こうすることで、一度に1つの*特定の種類*の問題に集中できます。

プロポーザル    | 内容 | upcoming featureフラグ 
:-----------|-------------|-------------
[SE-0401][] | プロパティラッパが行なうアクター隔離の推論の削除 | `DisableOutwardActorInference`
[SE-0412][] | グローバル変数に対するStrict concurrencyチェック | `GlobalConcurrency`
[SE-0418][] | メソッドとkey pathリテラルに対する`Sendable`の推論 | `InferSendableFromCaptures`

[SE-0401]: https://github.com/swiftlang/swift-evolution/blob/main/proposals/0401-remove-property-wrapper-isolation.md
[SE-0412]: https://github.com/swiftlang/swift-evolution/blob/main/proposals/0412-strict-concurrency-for-global-variables.md
[SE-0418]: https://github.com/swiftlang/swift-evolution/blob/main/proposals/0418-inferring-sendable-for-methods.md

これらは独立して、どの順番でも有効にできます。

upcoming featureフラグによって明らかになった問題に対処したら、次のステップは、そのモジュールに対して、[厳密な並行性の確認を完全にする][CompleteChecking]ことです。これでコンパイラによるすべてのデータ隔離チェックが有効になります。

[CompleteChecking]: <doc:CompleteChecking>

## 警告に対処する

警告を調査する際には、1つの指針で行なうことを強くおすすめします。つまり、**今のコードの状態で正しくする**ということです。問題に対処するためにコードをリファクタリングしたいという衝動を抑えてください。

Strict Concurrency CheckをCompleteにして警告のない状態にするためには、必要なコードの変更量を最小限に抑えると効果的です。これが完了したら、警告を抑制するために適用した安全ではないなオプトアウトをより安全な隔離メカニズムを導入するタイミングを、リファクタリングをする機会の目安としてください。

> 重要: よくある問題に対処する方法については、<doc:CommonProblems>を参照してください。

## 繰り返す

最初のうちは、データ隔離の問題を無効にしたり回避したりするテクニックを使うことになるでしょう。上位モジュールで、これ以上問題を無効にしたり回避したりする必要がないと感じたら、ワークアラウンドが必要な依存関係のうちの1つを次のターゲットにしてください。

先に進むためにすべての警告を排除する必要はありません。とてもわずかな変更でさえもが大きな影響を与える可能性があることを覚えておいてください。依存関係の1つを更新できれば、いつでもその依存関係を利用しているモジュールに戻って作業できます。